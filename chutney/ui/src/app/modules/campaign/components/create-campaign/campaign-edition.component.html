<div class="create-campaign-container min-vh-100">
  <form [formGroup]="campaignForm" (ngSubmit)="saveCampaign()" autocomplete="off" class="w-100">
    <div class ="d-flex flex-md-row justify-content-between">
      <div>
        <h4 id="myCampaignLabel">
          {{campaign.id ? ('campaigns.edition.title.update' | translate) : (('campaigns.edition.title.create' | translate))}}
        </h4>
      </div>
      <div>
        <button type="submit" [disabled]="submitted && campaignForm.invalid" class="btn btn-success m-2">
          <span class="fa fa-check"></span>&nbsp;
          <span>{{ 'global.actions.record' | translate }}</span>
        </button>
        <button type="button" class="btn btn-secondary m-2" (click)="clear()">
          <span class="fa fa-times"></span>&nbsp;
          <span>{{ 'global.actions.cancel' | translate }}</span>
        </button>
      </div>
    </div>
    @if (errorMessage) {
      <div class="alert alert-dismissible alert-danger mt-4">
        <button type="button" class="btn-close" data-bs-dismiss="alert" (click)="errorMessage = null"></button>
        {{ errorMessage }}
      </div>
    }

    <div class="row row-cols-lg-auto g-3">
      <div class="col-sm-7">
        <label for="title">{{ 'campaigns.edition.form.title.label' | translate }}</label>
        <input type="text" id="title" class="form-control" formControlName="title">
        @if (submitted && this.campaignForm.hasError('required', 'title')) {
          <div class="error-message">
            {{ 'campaigns.edition.form.title.required' | translate }}
          </div>
        }
      </div>

      <div class="col-sm">
        <label for="description">{{ 'campaigns.edition.form.description' | translate }}</label>
        <input type="text" id="description" class="form-control" formControlName="description">
      </div>
    </div>
    <div class="row row-cols-lg-auto g-3">
      <div class="col-12">
        <label>{{'menu.principal.jiraId' | translate}}</label>
        <input type="text" class="form-control me-2 small-text"
          formControlName="jiraId" (change)="refreshJiraScenarios()"
          placeholder="id jira"/>
        <ng-template #jiraFieldHelp>{{'campaigns.edition.jiraIdInfo.testPlan' | translate}}<br>{{'campaigns.edition.jiraIdInfo.testExec' | translate}}</ng-template>
        <button type="button" class="btn btn-link position-relative float-end" style="margin-top: -34;"
          [ngbPopover]="jiraFieldHelp" placement="bottom"
          triggers="mouseenter:mouseleave">
          <span class="fa fa-info-circle" aria-hidden="true"></span>
        </button>
      </div>
      <div class="col-12">
        <label>{{'menu.principal.dataset' | translate}}</label>
        <chutney-dataset-selection
          [selectedDatasetId]="campaign.datasetId"
          (selectionEvent)="selectDataset($event)">
        </chutney-dataset-selection>
      </div>

      @if (environments) {
        <div class="col-12">
          <label>{{'admin.targets.environment' | translate}}</label>
          <chutney-environment-combo [environments]="environments" [defaultValue]="campaign.environment"
            (selectionEvent)="setSelectedEnvironment($event)">
          </chutney-environment-combo>
        </div>
      }

      <div class="col-12">
        <label>{{'campaigns.edition.form.tags' | translate}}</label>
        <input type="text" class="form-control me-2 small-text"
          formControlName="campaignTags" placeholder="tags"/>
      </div>
      <div class="col-12 ms-3">
        {{ 'campaigns.edition.options' | translate }} :
        <div class="ms-4">
          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="parallelCheck"
              formControlName="parallelRun">
            <label class="form-check-label"
            for="parallelCheck">{{ 'campaigns.edition.parallelRun' | translate }}</label>
          </div>
          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="retryAutoCheck"
              formControlName="retryAuto">
            <label class="form-check-label"
            for="retryAutoCheck">{{ 'campaigns.edition.retryAuto' | translate }}</label>
          </div>
        </div>
      </div>
    </div>
    <div class="row row-cols-lg-auto justify-content-end">
      <div class="col">
        <input name="search" type="text" class="form-control search-field mb-2 border" id="scenarioIds"
               formControlName="scenarioIds" placeholder="Filtrer scÃ©narios"
               [(ngModel)]="scenariosFilter"/>
        @if (itemList.length) {
        <ng-multiselect-dropdown [settings]="dropdownSettings"
                                 [data]="itemList"
                                 [placeholder]="'campaigns.edition.selectTag' | translate"
                                 (onSelect)="onItemSelect($event)"
                                 (onDeSelect)="OnItemDeSelect($event)"
                                 (onDeSelectAll)="OnItemDeSelectAll()"
                                 formControlName="tags">
        </ng-multiselect-dropdown>
        }
        @if (jiraScenarios.length > 0 && campaignForm.controls['onlyLinkedScenarios'].value === true) {
        <div class="pt-2">
          @if (jiraItemList.length) {
          <ng-multiselect-dropdown [settings]="dropdownSettings"
                                   [placeholder]="'campaigns.edition.selectJiraTag' | translate"
                                   [data]="jiraItemList"
                                   (onSelect)="onJiraItemSelect($event)"
                                   (onDeSelect)="OnJiraItemDeSelect($event)"
                                   (onDeSelectAll)="OnJiraItemDeSelectAll()"
                                   formControlName="jiratags">
          </ng-multiselect-dropdown>
          }
        </div>
        }
      </div>
    </div>
    <div class="row">
      <!-- Left side -->
      <div class="col-md-6">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <th colspan="4">
                {{ 'campaigns.edition.scenarios.title' | translate }}
              </th>
              <th class="text-center pe-5">Dataset</th>
              <th></th>
            </thead>
            <tbody dragula="DRAGGABLE" [(dragulaModel)]="scenariosToAdd">
              @for (scenario of scenariosToAdd; track scenario; let index = $index) {
                <tr class="cursor">
                  <td class="text-nowrap">{{scenario?.scenarioId.id}}</td>
                  <td class="scenario-title-cell">{{scenario?.scenarioId.title}}</td>
                  <td class="p-0">
                    @if (jiraMap.has(scenario.id)) {
                      <span
                        [ngClass]="getJiraLastExecutionStatusClass(scenario.scenarioId.id)" class="badge">
                        {{getJiraLastExecutionStatus(scenario.scenarioId.id)}}
                      </span>
                    }
                  </td>
                  <td class="p-0">
                    @if (jiraMap.has(scenario.id)) {
                      <a  role="button" class="btn btn-sm btn-link me-0"
                        target="_blank" href="{{getJiraLink(scenario.scenarioId.id)}}" rel="noopener noreferrer"
                        ngbPopover="{{jiraMap.get(scenario.scenarioId.id)}}" placement="left" (click)="$event.stopPropagation()"
                        triggers="mouseenter:mouseleave">
                        <span class="fab fa-jira" aria-hidden="true">
                        </span>
                      </a>
                    }
                  </td>
                  <td class="pe-5">
                    <chutney-dataset-selection
                        [selectedDatasetId]="scenario?.datasetId"
                        (selectionEvent)="selectDatasetScenario($event, index)">
                    </chutney-dataset-selection>
                  </td>
                  <td class="p-0">
                    <button type="button" class="btn btn-outline-primary btn-sm me-2"
                            (click)="removeScenario(index)">
                      <span class="fa fa-arrow-circle-right"></span>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      <!-- Right side -->
      <div class="col-md-6 mt-5">
        <div class="row table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <th colspan="5">
                {{ 'campaigns.edition.scenarios.pick.title' | translate }}
              </th>
              <th></th>
              </thead>
            <tbody>
              @for (scenario of scenarios |  scenarioCampaignSearch : selectedTags | searchTextPipe  : scenariosFilter : ['title', 'id'] | withoutScenario:scenariosToAdd | withoutScenario:jiraScenariosToExclude; track scenario.id) {
                <tr>
                  <td class="w-3">
                    <button type="button" class="btn btn-outline-success btn-sm"
                      (click)="addScenario(scenario)">
                      <span class="fa fa-arrow-circle-left"></span>
                    </button>
                  </td>
                  <td class="text-nowrap w-10">{{scenario?.id}}</td>
                  <td class="scenario-title-cell w-70">{{scenario?.title}}</td>
                  <td class="w-15">
                    @for (tag of scenario.tags; track $index) {
                      <span>
                        <span class="chutney-tag chutney-tag-selected">{{tag}}</span>
                      </span>
                    }
                  </td>
                  <td class="p-0">
                    @if (jiraMap.has(scenario.id)) {
                      <span
                        [ngClass]="getJiraLastExecutionStatusClass(scenario.id)" class="badge">
                        {{getJiraLastExecutionStatus(scenario.id)}}
                      </span>
                    }
                  </td>
                  <td class="p-0">
                    @if (jiraMap.has(scenario.id)) {
                      <a role="button" class="btn btn-sm btn-link me-0"
                        target="_blank" href="{{getJiraLink(scenario.id)}}" rel="noopener noreferrer"
                        ngbPopover="{{jiraMap.get(scenario.id)}}" placement="left" (click)="$event.stopPropagation()"
                        triggers="mouseenter:mouseleave">
                        <span class="fab fa-jira" aria-hidden="true">
                        </span>
                      </a>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </form>
</div>
